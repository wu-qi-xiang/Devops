# Nginx功能详解

## Web服务器功能

1. 可以运行HTML、JS、CSS、图片等静态数据
2. 结合FastCGI运行PHP等动态程序（常用`fastcgi_pass`）
3. 结合Tomcat支持Java动态程序（常用`proxy_pass`）

## 负载均衡

负载均衡是由多台服务器以对称的方式组合成一个服务器集合，每台服务器都具有等价的地位。通过负载分担技术，将外部发送来的请求均匀分配到服务器集合的每台服务器上，而接收到请求的服务器独立响应客户端的请求。这种方式可以解决大量并发访问服务的问题。

### OSI七层模型
- 物理层
- 数据链路层
- 网络层
- 传输层
- 会话层
- 表示层
- 应用层

### Nginx负载均衡实现

#### 1. 基于权重的负载均衡
```nginx
upstream nginx.com {
    # upstream的负载均衡，weight是权重，可以根据机器配置定义权重
    # weight参数表示权值，权值越高被分配到的几率越大
    server 192.168.80.121:80 weight=3 max_fails=3 fail_timeout=30s;  # 30秒时间内失败3次
    server 192.168.80.122:80 weight=2;
    server 192.168.80.123:80 weight=3;
}
```

#### 2. 基于IP的负载均衡
```nginx
upstream nginx.com {
    ip_hash;
    server 192.168.80.121:80;
    server 192.168.80.122:80 down;  # 表示永久离线状态
    server 192.168.80.123:80;
}
```

#### 代理配置示例
```nginx
location / {
    proxy_pass http://nginx.com;
}
```

## 代理功能

### 正向代理

正向代理是一个位于客户端和原始服务器(origin server)之间的服务器。为了从原始服务器取得内容，客户端向代理发送一个请求并指定目标(原始服务器)，然后代理向原始服务器转交请求并将获得的内容返回给客户端。客户端必须要进行一些特别的设置才能使用正向代理。

**用途：**
1. 访问原来无法访问的资源，如Google
2. 可以做缓存，加速访问资源
3. 对客户端访问授权，上网进行认证
4. 代理可以记录用户访问记录（上网行为管理），对外隐藏用户信息

### 反向代理

反向代理是指以代理服务器来接受internet上的连接请求，然后将请求转发给内部网络上的服务器，并将从服务器上得到的结果返回给internet上请求连接的客户端。此时代理服务器对外就表现为一个服务器。客户端将代理服务器看做是目的服务器。

**用途：**
1. 保证内网的安全，可以使用反向代理提供WAF功能，阻止web攻击
2. 负载均衡，通过反向代理服务器来优化网站的负载

### 缓存功能
类似Squid专业的缓存软件。

## Nginx特性

### 基本架构
- Master进程（主进程）
- Worker进程（工作进程）

### 主要特性
1. 模块化设计，较好的扩展性
2. 高可靠性
3. 低内存消耗
4. 支持热部署

### 基本功能
- 静态资源的web服务器，能缓存打开的文件描述符
- HTTP、SMTP、POP3协议的反代理服务器
- 缓存加速，负载均衡

### 扩展功能
- 支持keepalive
- 支持平滑升级
- 支持URL重写（rewrite）
- 支持路径别名
- 支持基于IP及用户的访问控制
- 支持速率限制
- 支持并发数限制

### 技术特性
- 事件驱动：epoll（边缘触发）、kqueue、/dev/poll
- 复用器：select、poll
- 支持sendfile、sendfile64
- 支持AIO
- 支持mmap
# LVS基础知识

## 基本概念

1. **DS (Director Server)**：前端负载均衡器节点
2. **RS (Real Server)**：后端真实的工作服务器
3. **VIP (Virtual IP)**：向外部直接面向用户请求，作为用户请求的目标的IP地址
4. **DIP (Director Server IP)**：主要用于和内部主机通讯的IP地址
5. **RIP (Real Server IP)**：后端服务器的IP地址
6. **CIP (Client IP)**：访问客户端的IP地址

## OSI七层模型

- 物理层
- 数据链路层
- 网络层
- 传输层
- 会话层
- 表示层
- 应用层

## LVS简介

**LVS (Linux Virtual Server)** 是一款四层负载均衡软件，针对TCP/IP做的转发和路由，具有稳定、效率高的特点。

LVS的核心部件是调度器(load balancer)，用来分发用户的请求给真实服务器（real server）。

## LVS实现方式

### 1. NAT模式
- 通过调度器（load balancer）分配和响应请求
- 调度器压力过大
- 真实服务器只有内网ip没有公网ip，节约ip资源
- 所有的Real Server节点必须设置自己的网关Gateway为LVS节点的网关

**数据报转换规则**：
- 客户端请求报文到LVS调度器之后，数据报报文的目的IP改成后端真实服务器IP
- 服务器处理完之后将响应报文发送到网关
- 经调度器时会将数据报报文中的源IP换成调度器的IP
- 然后返回给客户端

### 2. IP Tunnel模式
- 调度器将请求报文封装在IP报文中，再将封装的报文发送给真实服务器
- 服务器直接响应请求
- 服务器需要分配公网IP，比较浪费IP资源

### 3. DR模式
- 将数据帧的MAC地址改成服务器的MAC地址
- 服务器需要分配公网IP，比较浪费IP资源

**数据报转换规则**：
- 客户端的请求报文到LVS调度器之后，只会改写链路层的报文封装
- 将报文的目的IP改成真实服务器的IP
- 对网络层和传输层报文不进行改写
- 进行三层网络交换
- VIP是真实主机的回环IP

## LVS调度算法

1. **轮询调度(rr)**：按顺序把请求依次发送给后端的服务器

2. **带权重的轮询调度(wrr)**：设置的权重越高，服务器被分配到的请求就越多

3. **最小连接调度(lc)**：会将新的请求分配给连接数最小的服务器

4. **带权重的最小连接数(wlc)**：在最小连接数的基础上加上一个权重，人为的设置服务器的被分配的请求

5. **基于局部性的最小连接调度(LBLC)**：将相同目标IP地址的请求分配到一台相同的服务器上，提高主存cache的命中率

6. **带复制的基于局部性最少链接调度(LBLCR)**：先找出相同目标IP地址对应的服务器组，然后找出一台最小连接数的服务器分配请求

7. **目标地址散列调度(destination hashing)**：通过hash算法将目标IP地址映射到一台服务器上

8. **源地址散列调度(source hashing)**：通过hash算法将请求的源IP地址映射到对应的服务器上

## 参考资料

https://www.cnblogs.com/dion-90/articles/8523009.html

